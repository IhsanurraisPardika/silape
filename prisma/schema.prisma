generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum PeranPengguna {
  SUPERADMIN_TPM
  ADMIN
  TIM_PENILAI
}

enum StatusPenilaian {
  DRAFT
  SUBMIT
}

// kategori 5P tidak pakai tabel, tapi enum biar rapi dan fixed
enum PKode {
  P1
  P2
  P3
  P4
  P5
}

model Pengguna {
  // PK pakai email
  email         String @id @db.VarChar(191)
  nama          String @db.VarChar(191)
  kataSandiHash String @db.VarChar(191)

  peran PeranPengguna
  timId Int?

  statusAktif     Boolean   @default(true)
  dibuatOlehEmail String?
  dibuatPada      DateTime  @default(now())
  diubahPada      DateTime  @updatedAt
  dihapusPada     DateTime?

  tim Tim? @relation(fields: [timId], references: [id])

  // self-reference (siapa yang buat akun)
  dibuatOleh  Pengguna?  @relation("PenggunaDibuatOleh", fields: [dibuatOlehEmail], references: [email])
  membuatAkun Pengguna[] @relation("PenggunaDibuatOleh")

  // relasi transaksi
  penilaianSebagaiPenilai PenilaianIndividu[] @relation("Penilai")
  fotoDiunggah            FotoDetailPenilaian[]

  // relasi “dibuat oleh”
  kantorDibuat      Kantor[]
  penugasanDibuat   PenugasanKantorTim[]
  konfigurasiDibuat KonfigurasiBobot[]

  @@index([timId])
  @@index([peran])
  @@map("pengguna")
}

model Tim {
  id          Int     @id @default(autoincrement())
  kode        String  @unique @db.VarChar(50)
  nama        String  @db.VarChar(100)
  statusAktif Boolean @default(true)

  dibuatPada  DateTime  @default(now())
  diubahPada  DateTime  @updatedAt
  dihapusPada DateTime?

  anggota         Pengguna[]
  penugasanKantor PenugasanKantorTim[]
  penilaian       PenilaianIndividu[]

  @@map("tim")
}

model Kantor {
  id          Int     @id @default(autoincrement())
  kode        String? @db.VarChar(50)
  nama        String  @db.VarChar(191)
  statusAktif Boolean @default(true)

  dibuatOlehEmail String?
  dibuatPada      DateTime  @default(now())
  diubahPada      DateTime  @updatedAt
  dihapusPada     DateTime?

  dibuatOleh Pengguna? @relation(fields: [dibuatOlehEmail], references: [email])

  penugasanTim PenugasanKantorTim[]
  penilaian    PenilaianIndividu[]

  @@index([nama])
  @@index([dibuatOlehEmail])
  @@map("kantor")
}

model PenugasanKantorTim {
  id       Int @id @default(autoincrement())
  timId    Int
  kantorId Int

  statusAktif    Boolean   @default(true)
  tanggalMulai   DateTime?
  tanggalSelesai DateTime?

  dibuatOlehEmail String?
  dibuatPada      DateTime  @default(now())
  dihapusPada     DateTime?

  tim    Tim    @relation(fields: [timId], references: [id], onDelete: Cascade, map: "fk_penugasan_tim")
  kantor Kantor @relation(fields: [kantorId], references: [id], onDelete: Cascade, map: "fk_penugasan_kantor")
  dibuatOleh Pengguna? @relation(fields: [dibuatOlehEmail], references: [email], map: "fk_penugasan_dibuat_oleh")

  @@unique([timId, kantorId], map: "uq_penugasan_tim_kantor")
  @@index([kantorId], map: "idx_penugasan_kantor")
  @@index([dibuatOlehEmail], map: "idx_penugasan_dibuat_oleh")

  @@map("penugasan_kantor_tim")
}


model PeriodePenilaian {
  id          Int    @id @default(autoincrement())
  tahun       Int
  semester    Int
  bulan       Int?
  namaPeriode String @db.VarChar(100)

  tanggalMulai   DateTime?
  tanggalSelesai DateTime?
  statusAktif    Boolean   @default(true)

  dibuatPada DateTime @default(now())
  diubahPada DateTime @updatedAt

  konfigurasiBobot KonfigurasiBobot[]
  penilaian        PenilaianIndividu[]

  @@index([tahun, semester])
  @@index([tahun, semester, bulan])
  @@map("periode_penilaian")
}

model KonfigurasiBobot {
  id   Int    @id @default(autoincrement())
  nama String @db.VarChar(191)

  // kalau kamu mau bobot per periode, pakai periodeId
  periodeId     Int?
  berlakuMulai  DateTime?
  berlakuSampai DateTime?
  statusAktif   Boolean   @default(true)

  dibuatOlehEmail String?
  dibuatPada      DateTime @default(now())
  diubahPada      DateTime @updatedAt

  periode    PeriodePenilaian? @relation(fields: [periodeId], references: [id])
  dibuatOleh Pengguna?         @relation(fields: [dibuatOlehEmail], references: [email])

  // item bobot per kriteriaKey (tanpa tabel kriteria)
  items    BobotKriteria[]
  penilaian PenilaianIndividu[]

  @@index([periodeId])
  @@index([dibuatOlehEmail])
  @@map("konfigurasi_bobot")
}

model BobotKriteria {
  id            Int   @id @default(autoincrement())
  konfigurasiId Int

  pKode      PKode
  kriteriaKey String @db.VarChar(100) // contoh: "P1-01"
  namaKriteria String? @db.VarChar(191) // opsional snapshot nama dari FE

  bobotKriteria Decimal @db.Decimal(10, 2)

  dibuatPada DateTime @default(now())
  diubahPada DateTime @updatedAt

  konfigurasi KonfigurasiBobot @relation(fields: [konfigurasiId], references: [id], onDelete: Cascade)

  @@unique([konfigurasiId, kriteriaKey])
  @@index([pKode])
  @@map("bobot_kriteria")
}

model PenilaianIndividu {
  id Int @id @default(autoincrement())

  periodeId    Int
  kantorId     Int
  timId        Int
  penilaiEmail String @db.VarChar(191)

  konfigurasiBobotId Int?

  tanggalMulaiInput DateTime        @default(now())
  tanggalSubmit     DateTime?
  status            StatusPenilaian @default(DRAFT)

  // rekomendasi global (opsional)
  catatanRekomendasi String?  @db.Text
  dataSudahBenar     Boolean  @default(false)

  dibuatPada  DateTime  @default(now())
  diubahPada  DateTime  @updatedAt
  dihapusPada DateTime?

  periode PeriodePenilaian @relation(fields: [periodeId], references: [id])
  kantor  Kantor           @relation(fields: [kantorId], references: [id])
  tim     Tim              @relation(fields: [timId], references: [id])

  penilai Pengguna @relation("Penilai", fields: [penilaiEmail], references: [email])

  konfigurasiBobot KonfigurasiBobot? @relation(fields: [konfigurasiBobotId], references: [id])

  detail DetailPenilaian[]

  @@unique([periodeId, kantorId, timId, penilaiEmail])
  @@index([timId, kantorId])
  @@index([status])
  @@index([penilaiEmail])
  @@map("penilaian_individu")
}

model DetailPenilaian {
  id          Int @id @default(autoincrement())
  penilaianId Int

  // tanpa tabel kriteria, kita simpan identitas dari FE
  pKode       PKode
  kriteriaKey String  @db.VarChar(100)  // contoh: "P3-04"
  namaKriteria String? @db.VarChar(191) // opsional snapshot label

  nilai   Decimal @db.Decimal(5, 2)
  catatan String? @db.Text

  bobotSaatDinilai Decimal  @db.Decimal(10, 2)
  dibuatPada       DateTime @default(now())
  diubahPada       DateTime @updatedAt

  penilaian PenilaianIndividu @relation(fields: [penilaianId], references: [id], onDelete: Cascade)

  fotoKondisi FotoDetailPenilaian[]

  @@unique([penilaianId, kriteriaKey])
  @@index([pKode])
  @@index([penilaianId, pKode])
  @@map("detail_penilaian")
}

model FotoDetailPenilaian {
  id       Int @id @default(autoincrement())
  detailId Int

  urlFile    String  @db.VarChar(500)
  namaFile   String? @db.VarChar(191)
  tipeFile   String? @db.VarChar(50)
  ukuranFile Int?
  keterangan String? @db.Text

  diunggahOlehEmail String?   @db.VarChar(191)
  tanggalUnggah     DateTime  @default(now())
  dihapusPada       DateTime?

  detail       DetailPenilaian @relation(fields: [detailId], references: [id], onDelete: Cascade)
  diunggahOleh Pengguna?       @relation(fields: [diunggahOlehEmail], references: [email])

  @@index([detailId])
  @@index([diunggahOlehEmail])
  @@map("foto_detail_penilaian")
}

model RekapPenilaianTimKantor {
  id        Int @id @default(autoincrement())
  periodeId Int
  timId     Int
  kantorId  Int

  status StatusRekap @default(PROSES)

  nilaiP1    Decimal? @db.Decimal(5, 2)
  nilaiP2    Decimal? @db.Decimal(5, 2)
  nilaiP3    Decimal? @db.Decimal(5, 2)
  nilaiP4    Decimal? @db.Decimal(5, 2)
  nilaiP5    Decimal? @db.Decimal(5, 2)
  nilaiAkhir Decimal? @db.Decimal(5, 2)

  predikatId           Int?
  terakhirDihitungPada DateTime?

  periode  PeriodePenilaian @relation(fields: [periodeId], references: [id])
  tim      Tim              @relation(fields: [timId], references: [id])
  kantor   Kantor           @relation(fields: [kantorId], references: [id])
  predikat Predikat?        @relation(fields: [predikatId], references: [id])

  @@unique([periodeId, timId, kantorId])
  @@index([periodeId, timId])
  @@map("rekap_penilaian_tim_kantor")
}

model RekapKriteriaTimKantor {
  id         Int @id @default(autoincrement())
  periodeId  Int
  timId      Int
  kantorId   Int
  kriteriaId Int

  nilaiRataRata        Decimal   @db.Decimal(5, 2)
  bobotKriteria        Decimal   @db.Decimal(10, 2)
  terakhirDihitungPada DateTime?

  periode  PeriodePenilaian  @relation(fields: [periodeId], references: [id])
  tim      Tim               @relation(fields: [timId], references: [id])
  kantor   Kantor            @relation(fields: [kantorId], references: [id])
  kriteria KriteriaPenilaian @relation(fields: [kriteriaId], references: [id])

  @@unique([periodeId, timId, kantorId, kriteriaId])
  @@index([periodeId, timId, kantorId])
  @@map("rekap_kriteria_tim_kantor")
}

model LogUnduhLaporan {
  id            Int          @id @default(autoincrement())
  penggunaEmail String       @db.VarChar(191)
  periodeId     Int
  timId         Int?
  jenis         JenisLaporan

  dibuatPada DateTime @default(now())

  pengguna Pengguna         @relation(fields: [penggunaEmail], references: [email])
  periode  PeriodePenilaian @relation(fields: [periodeId], references: [id])
  tim      Tim?             @relation(fields: [timId], references: [id])

  @@index([periodeId, timId])
  @@index([penggunaEmail])
  @@map("log_unduh_laporan")
}
