generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum PeranPengguna {
  SUPERADMINTPM
  ADMIN
  TIMPENILAI
}

enum StatusPenilaian {
  DRAFT
  SUBMIT
}

enum TimKode {
  TIM1
  TIM2
  TIM3
  TIM4
  TIM5
  TIM6
  TIM7
  TIM8
  TIM9
  TIM10
}

enum KategoriPenilaian {
  P1
  P2
  P3
  P4
  P5
}

model Pengguna {
  // PK pakai email
  email         String @id @db.VarChar(191)
  kataSandiHash String @db.VarChar(191)

  peran   PeranPengguna
  timKode TimKode? @unique // hanya untuk akun tim penilai (peran=TIMPENILAI)

  statusAktif Boolean  @default(true)
  dibuatPada  DateTime @default(now())
  diubahPada  DateTime @updatedAt
  dihapusPada DateTime?

  // anggota tim (maks 5, ketua = urutan 1)
  anggotaTim AnggotaTim[]

  // relasi transaksi
  penugasanKantor PenugasanKantorAkun[]
  penilaian       Penilaian[]

  konfigurasiBobotDibuat KonfigurasiBobot[] @relation("KonfigurasiDibuatOleh")
  periodeDibuat          PeriodePenilaian[] @relation("PeriodeDibuatOleh")

  @@index([peran])
  @@index([statusAktif])
  @@map("pengguna")
}

model AnggotaTim {
  id        Int    @id @default(autoincrement())
  akunEmail String @db.VarChar(191)
  urutan    Int
  nama      String @db.VarChar(191)
  statusAktif Boolean @default(true)

  akun Pengguna @relation(fields: [akunEmail], references: [email], onDelete: Cascade)

  // INI YANG KURANG:
  penilaian Penilaian[] @relation("AnggotaPenilai")

  @@unique([akunEmail, urutan])
  @@index([akunEmail])
  @@map("anggota_tim")
}

model PeriodePenilaian {
  id       Int @id @default(autoincrement())
  tahun    Int
  semester Int // 1 atau 2

  namaPeriode String @db.VarChar(100) // mis: "2026 Semester 1"
  statusAktif Boolean @default(true)

  dibuatOlehEmail String?
  dibuatPada      DateTime @default(now())
  diubahPada      DateTime @updatedAt

  dibuatOleh Pengguna? @relation("PeriodeDibuatOleh", fields: [dibuatOlehEmail], references: [email])

  penugasanKantor  PenugasanKantorAkun[]
  konfigurasiBobot KonfigurasiBobot[]
  penilaian        Penilaian[]

  // mencegah periode ganda
  @@unique([tahun, semester])
  @@index([statusAktif])
  @@map("periode_penilaian")
}

model Kantor {
  id   Int    @id @default(autoincrement())
  nama String @db.VarChar(191)

  statusAktif Boolean  @default(true)
  dibuatPada  DateTime @default(now())
  diubahPada  DateTime @updatedAt
  dihapusPada DateTime?

  penugasanKantor PenugasanKantorAkun[]
  penilaian       Penilaian[]

  @@index([nama])
  @@map("kantor")
}

model PenugasanKantorAkun {
  id        Int @id @default(autoincrement())
  periodeId Int
  kantorId  Int

  // akun tim penilai yang ditugaskan
  akunEmail String @db.VarChar(191)

  statusAktif    Boolean   @default(true)
  tanggalMulai   DateTime?
  tanggalSelesai DateTime?

  dibuatPada  DateTime  @default(now())
  diubahPada  DateTime  @updatedAt
  dihapusPada DateTime?

  periode PeriodePenilaian @relation(fields: [periodeId], references: [id], onDelete: Cascade)
  kantor  Kantor           @relation(fields: [kantorId], references: [id], onDelete: Cascade)
  akun    Pengguna         @relation(fields: [akunEmail], references: [email], onDelete: Cascade)

  // default asumsi: 1 kantor hanya ditugaskan ke 1 akun pada 1 periode
  @@unique([periodeId, kantorId])
  @@index([akunEmail])
  @@index([periodeId])
  @@map("penugasan_kantor_akun")
}

model KonfigurasiBobot {
  id        Int    @id @default(autoincrement())
  periodeId Int

  nama        String  @db.VarChar(191)
  statusAktif Boolean @default(true)

  dibuatOlehEmail String?
  dibuatPada      DateTime @default(now())
  diubahPada      DateTime @updatedAt

  periode   PeriodePenilaian @relation(fields: [periodeId], references: [id], onDelete: Cascade)
  dibuatOleh Pengguna?       @relation("KonfigurasiDibuatOleh", fields: [dibuatOlehEmail], references: [email])

  bobotKriteria BobotKriteria[]
  penilaian     Penilaian[]

  @@index([periodeId])
  @@index([statusAktif])
  @@map("konfigurasi_bobot")
}

model BobotKriteria {
  id            Int @id @default(autoincrement())
  konfigurasiId Int

  kategori     KategoriPenilaian
  kunciKriteria String @db.VarChar(50) // contoh: "P1-1", "P2-3" (samakan dengan frontend)
  bobot        Decimal @db.Decimal(10, 2)

  dibuatPada DateTime @default(now())
  diubahPada DateTime @updatedAt

  konfigurasi KonfigurasiBobot @relation(fields: [konfigurasiId], references: [id], onDelete: Cascade)

  @@unique([konfigurasiId, kategori, kunciKriteria])
  @@index([konfigurasiId])
  @@map("bobot_kriteria")
}

model Penilaian {
  id        Int @id @default(autoincrement())
  periodeId Int
  kantorId  Int

  // akun tim yang login
  akunEmail String @db.VarChar(191)

  // siapa anggota yang dipilih saat menilai
  anggotaId Int

  konfigurasiBobotId Int?

  tanggalMulaiInput DateTime        @default(now())
  tanggalSubmit     DateTime?
  status            StatusPenilaian @default(DRAFT)

  catatanRekomendasi String? @db.Text
  nilaiTotal         Decimal? @db.Decimal(6, 2)

  dibuatPada  DateTime  @default(now())
  diubahPada  DateTime  @updatedAt
  dihapusPada DateTime?

  periode PeriodePenilaian @relation(fields: [periodeId], references: [id], onDelete: Cascade)
  kantor  Kantor           @relation(fields: [kantorId], references: [id], onDelete: Cascade)
  akun    Pengguna         @relation(fields: [akunEmail], references: [email], onDelete: Cascade)
  anggota AnggotaTim @relation("AnggotaPenilai", fields: [anggotaId], references: [id], onDelete: Restrict)

  konfigurasiBobot KonfigurasiBobot? @relation(fields: [konfigurasiBobotId], references: [id], onDelete: SetNull)

  detail DetailPenilaian[]

  // mencegah 1 anggota menilai kantor yang sama di periode yang sama lebih dari sekali
  @@unique([periodeId, kantorId, akunEmail, anggotaId])
  @@index([akunEmail])
  @@index([periodeId, kantorId])
  @@index([status])
  @@map("penilaian")
}

model DetailPenilaian {
  id         Int @id @default(autoincrement())
  penilaianId Int

  kategori      KategoriPenilaian
  kunciKriteria String @db.VarChar(50)

  nilai   Decimal @db.Decimal(6, 2)
  catatan String? @db.Text

  // snapshot bobot saat input (biar laporan stabil meski bobot berubah)
  bobotSaatDinilai Decimal @db.Decimal(10, 2)

  dibuatPada DateTime @default(now())
  diubahPada DateTime @updatedAt

  penilaian Penilaian @relation(fields: [penilaianId], references: [id], onDelete: Cascade)

  foto FotoDetailPenilaian[]

  @@unique([penilaianId, kategori, kunciKriteria])
  @@index([penilaianId])
  @@map("detail_penilaian")
}

model FotoDetailPenilaian {
  id       Int @id @default(autoincrement())
  detailId Int

  urlFile    String  @db.VarChar(500)
  namaFile   String? @db.VarChar(191)
  tipeFile   String? @db.VarChar(50)
  ukuranFile Int?

  tanggalUnggah DateTime  @default(now())
  dihapusPada   DateTime?

  detail DetailPenilaian @relation(fields: [detailId], references: [id], onDelete: Cascade)

  @@index([detailId])
  @@map("foto_detail_penilaian")
}
