<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kelola Tim Penilai</title>
  <link rel="icon" href="/images/sp.png" type="image/sp.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 antialiased">
  <!-- Wrapper UTAMA: sama pola adminDashboard -->
  <div class="flex h-screen overflow-hidden">

    <!-- OVERLAY (mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 z-30 bg-black/40 hidden md:hidden"></div>

    <!-- SIDEBAR WRAPPER (mobile drawer, desktop static) -->
    <div
      id="sidebarWrapper"
      class="
        fixed inset-y-0 left-0 z-40
        -translate-x-full
        transition-transform duration-300 ease-in-out
        md:static md:translate-x-0
        h-screen md:h-full
        overflow-y-auto md:overflow-visible
      "
    >
      <div class="relative h-full">
        <!-- Close button (mobile) -->
        <button
          id="btnSidebarClose"
          type="button"
          class="md:hidden absolute top-3 right-3 z-50 inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/15 hover:bg-white/25 text-white"
          aria-label="Tutup sidebar"
        >
          ✕
        </button>

        <!-- Sidebar partial -->
        <%- include('../partials/sidebarAdmin') %>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="flex-1 flex flex-col overflow-hidden">

      <!-- MOBILE TOPBAR (md- only) -->
      <div class="md:hidden sticky top-0 z-20 bg-white border-b border-gray-200">
        <div class="h-14 px-4 flex items-center justify-between gap-3">
          <button
            id="btnSidebarOpen"
            type="button"
            class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-gray-200 bg-white hover:bg-gray-50"
            aria-label="Buka sidebar"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <div class="font-semibold text-gray-900 truncate">Kelola Tim</div>
          <div class="w-10 h-10"></div>
        </div>
      </div>

      <!-- Header (desktop only) -->
      <div class="hidden md:block">
        <%- include('../partials/header') %>
      </div>

      <!-- MAIN: yang scroll hanya area ini -->
      <main class="flex-1 overflow-auto bg-gray-50 flex flex-col">

        <!-- PAGE CONTENT -->
        <div class="p-4 sm:p-6 lg:p-8 pb-24">
          <div class="max-w-6xl mx-auto space-y-6">

            <!-- Title + Button -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <h1 class="text-2xl font-bold text-gray-900">Kelola Tim</h1>

              <button
                type="button"
                id="btnOpenTambah"
                class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-red-700 text-white shadow hover:bg-red-800 active:scale-[0.99] whitespace-nowrap"
              >
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
                Tambah Pengguna
              </button>
            </div>

            <!-- Tabs -->
            <div class="flex gap-3 overflow-x-auto whitespace-nowrap pb-1">
              <a href="/admin/kelola-tim"
                 class="px-5 py-3 rounded-xl bg-red-700 text-white shadow shrink-0">
                Kelola Tim Penilai
              </a>
              <a href="/kelolaKantor"
                 class="px-5 py-3 rounded-xl bg-white text-gray-700 shadow border border-gray-200 hover:bg-gray-50 shrink-0">
                Kelola Kantor Tim
              </a>
            </div>

            <!-- Table Card -->
            <div class="bg-white rounded-2xl shadow border border-gray-100 overflow-hidden">
              <div class="bg-red-700 text-white px-6 py-4 font-semibold">
                Daftar Tim Penilai
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-red-700/95 text-white">
                    <tr>
                      <th class="text-left px-6 py-4 font-semibold">Nama</th>
                      <th class="text-left px-6 py-4 font-semibold">Tim</th>
                      <th class="text-left px-6 py-4 font-semibold">Status</th>
                      <th class="text-left px-6 py-4 font-semibold">Aksi</th>
                    </tr>
                  </thead>

                  <tbody class="divide-y divide-gray-100">
                    <% if (!users || users.length === 0) { %>
                      <tr>
                        <td class="px-6 py-6 text-gray-500" colspan="4">
                          Belum ada data pengguna.
                        </td>
                      </tr>
                    <% } else { %>
                      <% users.forEach((u) => { %>
                        <tr class="hover:bg-gray-50">
                          <td class="px-6 py-5 font-medium text-gray-800"><%= u.nama %></td>
                          <td class="px-6 py-5 text-gray-700"><%= u.timNama || "-" %></td>

                          <td class="px-6 py-5">
                            <% if (u.statusAktif) { %>
                              <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-green-200 text-green-800 font-semibold">
                                Aktif
                              </span>
                            <% } else { %>
                              <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-gray-200 text-gray-700 font-semibold">
                                Nonaktif
                              </span>
                            <% } %>
                          </td>

                          <td class="px-6 py-5">
                            <div class="flex items-center gap-6">
                              <button
                                type="button"
                                class="text-blue-600 font-semibold hover:underline btnOpenEdit"
                                data-email="<%= u.email %>"
                                data-nama="<%= u.nama %>"
                                data-timid="<%= u.timId || '' %>"
                              >
                                Edit
                              </button>

                              <form action="/pengguna/hapus" method="POST" onsubmit="return confirm('Yakin hapus pengguna ini?')">
                                <input type="hidden" name="email" value="<%= u.email %>"/>
                                <button type="submit" class="text-red-600 font-semibold hover:underline">
                                  Delete
                                </button>
                              </form>
                            </div>
                          </td>
                        </tr>
                      <% }) %>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>

        <!-- FOOTER: pakai mt-auto supaya “nempel bawah” kalau konten pendek -->
        <div class="mt-auto">
          <%- include('../partials/footer') %>
        </div>
      </main>
    </div>
  </div>

  <!-- ================= MODAL: TAMBAH ================= -->
  <div id="modalTambah" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close="modalTambah"></div>

    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl flex flex-col">
      <div class="bg-red-700 text-white px-6 py-5 flex items-center justify-between">
        <div>
          <div class="text-lg font-bold">Tambah Tim Penilai</div>
          <div class="text-sm opacity-90">Buat Akun Untuk Tim Penilai</div>
        </div>

        <button type="button" class="text-white/90 hover:text-white" data-close="modalTambah">✕</button>
      </div>

      <form action="/pengguna/tambah" method="POST" class="p-6 space-y-5 overflow-y-auto">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Nama</label>
          <input name="nama" required
                 class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none"
                 placeholder="Masukkan nama..." />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
          <input name="email" type="email" required
                 class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none"
                 placeholder="Masukkan email..." />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
          <input name="password" type="password" required
                 class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none"
                 placeholder="Masukkan password..." />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Role</label>
          <select name="peran" id="selectRoleTambah" required
                  class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none bg-white">
            <option value="" selected disabled>Pilih Role...</option>
            <option value="SUPERADMIN_TPM">SUPERADMIN_TPM</option>
            <option value="ADMIN">ADMIN</option>
            <option value="TIM_PENILAI">TIM_PENILAI</option>
          </select>
        </div>

        <div id="wrapTimTambah" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Tim</label>
          <select name="timId"
                  class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none bg-white">
            <option value="" selected disabled>Pilih Tim...</option>
            <% if (timList && timList.length) { %>
              <% timList.forEach((t) => { %>
                <option value="<%= t.id %>"><%= t.nama %></option>
              <% }) %>
            <% } %>
          </select>
        </div>

        <div class="mt-8 flex items-center justify-end gap-3">
          <button type="button" data-close="modalTambah"
                  class="px-6 py-3 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">
            Batal
          </button>

          <button type="submit"
                  class="px-6 py-3 rounded-xl bg-red-700 text-white font-semibold hover:bg-red-800">
            Tambah
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= MODAL: EDIT ================= -->
  <div id="modalEdit" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close="modalEdit"></div>

    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl flex flex-col">
      <div class="bg-red-700 text-white px-6 py-5 flex items-center justify-between">
        <div>
          <div class="text-lg font-bold">Edit Tim Penilai</div>
          <div class="text-sm opacity-90">Edit Identitas Akun Untuk Tim Penilai</div>
        </div>

        <button type="button" class="text-white/90 hover:text-white" data-close="modalEdit">✕</button>
      </div>

      <form action="/pengguna/edit" method="POST" class="p-6 space-y-5 overflow-y-auto">
        <input type="hidden" name="email" id="editEmailHidden" />

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Nama</label>
          <input name="nama" id="editNama" required
                 class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
          <input id="editEmailShow" type="email" readonly
                 class="w-full rounded-xl border border-red-600 bg-gray-50 px-4 py-3 outline-none" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
          <input name="password" id="editPassword" type="password"
                 class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none"
                 placeholder="Isi jika ingin ganti password..." />
          <p class="text-xs text-gray-500 mt-2">Kosongkan jika tidak ingin mengubah password.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Tim</label>
          <select name="timId" id="editTimId"
                  class="w-full rounded-xl border border-red-600 focus:ring-2 focus:ring-red-500 focus:border-red-500 px-4 py-3 outline-none bg-white">
            <option value="">-</option>
            <% if (timList && timList.length) { %>
              <% timList.forEach((t) => { %>
                <option value="<%= t.id %>"><%= t.nama %></option>
              <% }) %>
            <% } %>
          </select>
        </div>

        <div class="mt-8 flex items-center justify-end gap-3">
          <button type="button" data-close="modalEdit"
                  class="px-6 py-3 rounded-xl bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">
            Batal
          </button>

          <button type="submit"
                  class="px-6 py-3 rounded-xl bg-red-700 text-white font-semibold hover:bg-red-800">
            Simpan
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===================== BODY LOCK (sidebar + modal tidak tabrakan) =====================
    let sidebarOpen = false;
    let openModals = 0;

    function syncBodyLock() {
      if (sidebarOpen || openModals > 0) document.body.classList.add('overflow-hidden');
      else document.body.classList.remove('overflow-hidden');
    }

    // ===================== SIDEBAR DRAWER (MOBILE) =====================
    const sidebarWrapper = document.getElementById('sidebarWrapper');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const btnSidebarOpen = document.getElementById('btnSidebarOpen');
    const btnSidebarClose = document.getElementById('btnSidebarClose');

    function openSidebar() {
      sidebarWrapper.classList.remove('-translate-x-full');
      sidebarOverlay.classList.remove('hidden');
      sidebarOpen = true;
      syncBodyLock();
    }

    function closeSidebar() {
      sidebarWrapper.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
      sidebarOpen = false;
      syncBodyLock();
    }

    btnSidebarOpen?.addEventListener('click', openSidebar);
    btnSidebarClose?.addEventListener('click', closeSidebar);
    sidebarOverlay?.addEventListener('click', closeSidebar);

    function syncSidebarOnResize() {
      if (window.innerWidth >= 768) {
        // Desktop: overlay selalu off; drawer state tidak relevan
        sidebarOverlay.classList.add('hidden');
        sidebarOpen = false;
        syncBodyLock();
      } else {
        // Mobile default: sidebar tertutup
        sidebarWrapper.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
        sidebarOpen = false;
        syncBodyLock();
      }
    }

    window.addEventListener('resize', syncSidebarOnResize);
    syncSidebarOnResize();

    // ===================== MODAL HELPERS =====================
    function openModal(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('hidden');
      openModals += 1;
      syncBodyLock();
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if (!el || el.classList.contains('hidden')) return;
      el.classList.add('hidden');
      openModals = Math.max(0, openModals - 1);
      syncBodyLock();
    }

    // Close modal via overlay & button
    document.addEventListener('click', (e) => {
      const closeTarget = e.target.getAttribute('data-close');
      if (closeTarget) closeModal(closeTarget);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSidebar();
        closeModal('modalTambah');
        closeModal('modalEdit');
      }
    });

    // Open Tambah
    document.getElementById('btnOpenTambah')?.addEventListener('click', () => openModal('modalTambah'));

    // Role toggle Tim (Tambah)
    const selectRoleTambah = document.getElementById('selectRoleTambah');
    const wrapTimTambah = document.getElementById('wrapTimTambah');

    function toggleTimTambah() {
      const val = selectRoleTambah?.value;
      if (val === 'TIM_PENILAI') wrapTimTambah?.classList.remove('hidden');
      else wrapTimTambah?.classList.add('hidden');
    }
    selectRoleTambah?.addEventListener('change', toggleTimTambah);

    // Open Edit + fill data
    document.querySelectorAll('.btnOpenEdit').forEach((btn) => {
      btn.addEventListener('click', () => {
        const email = btn.dataset.email || '';
        const nama = btn.dataset.nama || '';
        const timId = btn.dataset.timid || '';

        document.getElementById('editEmailHidden').value = email;
        document.getElementById('editEmailShow').value = email;
        document.getElementById('editNama').value = nama;
        document.getElementById('editPassword').value = '';

        const select = document.getElementById('editTimId');
        if (select) select.value = timId;

        openModal('modalEdit');
      });
    });
  </script>
</body>
</html>